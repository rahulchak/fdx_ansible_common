---
- name: Ensure group exists
  group:
    name: "{{ item.group }}"
    state: present
  when: 
    - item.group is defined
    - not item.exclusion_var | default('false') | bool
  with_items: "{{ main_item.files_to_copy }}"

- name: Ensure user exists
  user:
    name: "{{ item.owner }}"
    state: present
    group: "{{ item.group | default('') }}"
    append: true
    system: true
  when: 
    - item.owner is defined
    - not item.exclusion_var | default('false') | bool
  with_items: "{{ main_item.files_to_copy }}"

- name: copy files
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode | default('0755') }}"
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
  when: 
    - item.owner is defined
    - not item.exclusion_var | default('false') | bool 
  with_items: "{{ main_item.files_to_copy }}"
